<!DOCTYPE html>
<html lang="en">

<head>
    
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<meta name="HandheldFriendly" content="True" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<meta name="generator" content="Hugo 0.102.3" />


<link rel="shortcut icon" href="https://raw.githubusercontent.com/leeleelee3264/twitter_project/master/favicon.ico" />



<title>Python decorator로 간단한 profiler 구현하기 - dev_leelee.log</title>


<meta name="author" content="leeleelee3264" />


<meta name="description" content="All about python profiler decorator." />


<meta name="keywords" content="Backend" />


<meta property="og:title" content="Python decorator로 간단한 profiler 구현하기" />
<meta name="twitter:title" content="Python decorator로 간단한 profiler 구현하기" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://leeleelee3264.github.io/post/2022-06-30-python-profiler-decorator/" /><meta property="og:description" content="All about python profiler decorator." />
<meta name="twitter:description" content="All about python profiler decorator." /><meta property="og:image" content="https://leeleelee3264.github.io/img/og.png" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://leeleelee3264.github.io/img/og.png" /><meta property="article:published_time" content="2022-06-29T00:00:00+00:00" /><meta property="article:modified_time" content="2022-06-29T00:00:00+00:00" />


<style>
    @media (prefers-color-scheme: dark) {
        body[data-theme='auto'] img {
            filter: brightness(60%);
        }
    }

    body[data-theme='dark'] img {
        filter: brightness(60%);
    }
</style>




<link rel="stylesheet" href="https://leeleelee3264.github.io/assets/css/fuji.min.css" />








</head>

<body
  data-theme="auto"
  data-theme-auto='true'
  >
    <script data-cfasync="false">
  
  var fujiThemeData = localStorage.getItem('fuji_data-theme');
  
  if (!fujiThemeData) {
    localStorage.setItem('fuji_data-theme', 'auto');
  } else {
    
    if (fujiThemeData !== 'auto') {
      document.body.setAttribute('data-theme', fujiThemeData === 'dark' ? 'dark' : 'light');
    }
  }
</script>

    <header>
    <div class="container-lg clearfix">
        <div class="col-12 header">
            <a class="title-main" href="https://leeleelee3264.github.io/">dev_leelee.log</a>
            
            <span class="title-sub">Logfile of Developer LeeLee</span>
            
        </div>
    </div>
</header>

    <main>
        <div class="container-lg clearfix">
            
            <div class="col-12 col-md-9 float-left content">
                
<article>
    
    <h2 class="post-item post-title">
        <a href="https://leeleelee3264.github.io/post/2022-06-30-python-profiler-decorator/">Python decorator로 간단한 profiler 구현하기</a>
    </h2>
    <div class="post-item post-meta">
        <span><i class="iconfont icon-today-sharp"></i>&nbsp;2022-06-29</span>

<span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;1854 words</span>

<span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href="/tags/backend">Backend</a>&nbsp;</span>

    </div>
    
    <div class="post-content markdown-body">
        <br>
<br> 
<blockquote>
<p>간단한 프로파일링을 할 수 있는 profiler를 Python decorator로 구현한다.</p>
</blockquote>
<br> 
<p><strong>Index</strong></p>
<ol>
<li>profiler 구현 계기</li>
<li>profiler 구현</li>
<li>개선해야 하는 부분</li>
</ol>
<br> 
<h1 id="profiler-구현-계기">profiler 구현 계기</h1>
<p>Django 환경에서 unittest를 하며 간단하게 퍼포먼스를 측정하고 싶었다. 아주 간단하게 프로파일링을 하면 되기 때문에 Middleware 같은 것은 만들지 않았다. 대신에 Python의 decorator로 만들었다. 앞으로 더 심화되고 유익한 정보를 포함하고 있는 Profiler를 decorator 형식으로 만들면 유용할 것 같다.</p>
<br>
<blockquote>
<p>구현한 profiler</p>
</blockquote>
<ul>
<li><strong>메모리 사용량</strong>을 보기 위한 ram_profiler</li>
<li>함수에서 호출된 <strong>쿼리와 쿼리 실행시간</strong>을 보기 위한 query_profiler</li>
<li><strong>함수 실행시간</strong> 을 보기 위한 elapsed_timer</li>
</ul>
<br>
<h1 id="profiler-구현">profiler 구현</h1>
<h3 id="ram_profiler">ram_profiler</h3>
<p>이 프로파일러를 구현하다가 알게 된 사실인데 Python에서 메모리나 CPU 사용량을 보려면 <code>psutill builtin</code> 패키지를 사용하는 경우가 많았다.</p>
<p>decorator는 함수 호출 전과 후의 메모리 사용량을 가져와, 함수가 호출이 되면서 얼추 어느 정도의 메모리를 사용했는지 비교할 수 있도록 한다.</p>
<br>
<h4 id="ram_profiler-구현">ram_profiler 구현</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>def ram_profiler<span style="color:#f92672">(</span>fn<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    퍼포먼스 체크를 위한 메모리 프로파일러
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    메모리 사용량을 측정할 함수 위에 @ram_profiler 를 추가해주시면 됩니다.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    체크하는 메모리는 아래와 같습니다.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    1) 그냥 현재 memory usage 정보를 그대로 가져오는 경우
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    2) 현재 process id를 통해 해당 프로세스의 memory usage를 정확하게 비교하는 경우
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ex)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    @ram_profiler
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    def pre_allot_offering(offering: Offering):
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    def inner<span style="color:#f92672">(</span>*args, **kwargs<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;\n&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;===== memory usage check =====&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        memory_usage_dict <span style="color:#f92672">=</span> dict<span style="color:#f92672">(</span>psutil.virtual_memory<span style="color:#f92672">()</span>._asdict<span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>        memory_usage_percent <span style="color:#f92672">=</span> memory_usage_dict<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;percent&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#34;BEFORE CODE :: memory_usage_percent: {memory_usage_percent}%&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        pid <span style="color:#f92672">=</span> os.getpid<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        current_process <span style="color:#f92672">=</span> psutil.Process<span style="color:#f92672">(</span>pid<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        current_process_memory_usage_as_kb <span style="color:#f92672">=</span> current_process.memory_info<span style="color:#f92672">()[</span>0<span style="color:#f92672">]</span> / 2. ** <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#34;BEFORE CODE :: Current memory KB   : {current_process_memory_usage_as_kb: 9.3f} KB&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        target_func <span style="color:#f92672">=</span> fn<span style="color:#f92672">(</span>*args, **kwargs<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;==&#34;</span> * 20<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#34;== {fn.__name__} memory usage check ==&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        memory_usage_dict <span style="color:#f92672">=</span> dict<span style="color:#f92672">(</span>psutil.virtual_memory<span style="color:#f92672">()</span>._asdict<span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>        memory_usage_percent <span style="color:#f92672">=</span> memory_usage_dict<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;percent&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#34;AFTER  CODE :: memory_usage_percent: {memory_usage_percent}%&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        pid <span style="color:#f92672">=</span> os.getpid<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        current_process <span style="color:#f92672">=</span> psutil.Process<span style="color:#f92672">(</span>pid<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        current_process_memory_usage_as_kb <span style="color:#f92672">=</span> current_process.memory_info<span style="color:#f92672">()[</span>0<span style="color:#f92672">]</span> / 2. ** <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#34;AFTER  CODE :: Current memory KB   : {current_process_memory_usage_as_kb: 9.3f} KB&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;\n&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> target_func
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> inner</span></span></code></pre></td></tr></table>
</div>
</div>
<br>
<h4 id="ram_profiler-결과">ram_profiler 결과</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">=====</span> memory usage check <span style="color:#f92672">=====</span>
</span></span><span style="display:flex;"><span>BEFORE CODE :: memory_usage_percent: 79.7%
</span></span><span style="display:flex;"><span>BEFORE CODE :: Current memory KB   :   197.250 KB
</span></span><span style="display:flex;"><span><span style="color:#f92672">========================================</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">==</span> pre_allot_offering memory usage check <span style="color:#f92672">==</span>
</span></span><span style="display:flex;"><span>AFTER  CODE :: memory_usage_percent: 79.7%
</span></span><span style="display:flex;"><span>AFTER  CODE :: Current memory KB   :   197.312 KB</span></span></code></pre></div>
<br>
<h3 id="query_profiler">query_profiler</h3>
<p>decorator는 쿼리를 관리하는 context를 임포트 해와서 타겟 함수를 실행하면서 호출되었던 쿼리들을 캡처해두었다가 함수가 끝이 나면 보여준다.
ORM에서 실제로 어떤 쿼리가 실행되는지 봐야 할 때, 조건문에 따라 쿼리가 달라질 때, N + 1 쿼리를 잡아 낼 때 사용하기 좋다.</p>
<br>
<h4 id="query_profiler-구현">query_profiler 구현</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>def query_profiler<span style="color:#f92672">(</span>fn<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    호출이 된 query를 확인하기 위한 프로파일러
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    호출 된 query를 확인할 함수 위헤 @query_profiler 를 추가해주시면 됩니다.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ex)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    @query_profiler
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    def pre_allot_offering(offering: Offering):
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    def inner<span style="color:#f92672">(</span>*args, **kwargs<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;\n&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#34;===== {fn.__name__} called query check =====&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        with CaptureQueriesContext<span style="color:#f92672">(</span>connection<span style="color:#f92672">)</span> as context:
</span></span><span style="display:flex;"><span>            target_func <span style="color:#f92672">=</span> fn<span style="color:#f92672">(</span>*args, **kwargs<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> index, query in enumerate<span style="color:#f92672">(</span>context.captured_queries<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                sql <span style="color:#f92672">=</span> query.get<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;sql&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                time <span style="color:#f92672">=</span> query.get<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;time&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#39;CALLED QUERY :: [{index}]&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#39;CALLED QUERY :: query: {sql}&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#39;CALLED QUERY :: executed time: {time}&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                print<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;=====&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> target_func
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> inner</span></span></code></pre></td></tr></table>
</div>
</div>
<br>
<h4 id="query_profiler-결과">query_profiler 결과</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">=====</span> pre_allot_offering called query check <span style="color:#f92672">=====</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: <span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: query: SAVEPOINT <span style="color:#e6db74">`</span>s4377609600_x5<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: executed time: 0.001
</span></span><span style="display:flex;"><span><span style="color:#f92672">=====</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: <span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: query: SELECT <span style="color:#e6db74">`</span>offering_subscription<span style="color:#e6db74">`</span>.<span style="color:#e6db74">`</span>id<span style="color:#e6db74">`</span> <span style="color:#75715e"># 실제 쿼리는 블라인드</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: executed time: 0.00
</span></span><span style="display:flex;"><span><span style="color:#f92672">=====</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: <span style="color:#f92672">[</span>2<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: query: UPDATE <span style="color:#e6db74">`</span>offering_subscription<span style="color:#e6db74">`</span> SET  <span style="color:#75715e"># 실제 쿼리는 블라인드</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: executed time: 0.003
</span></span><span style="display:flex;"><span><span style="color:#f92672">=====</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: <span style="color:#f92672">[</span>3<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: query: SELECT <span style="color:#e6db74">`</span>offering_subscription<span style="color:#e6db74">`</span>.<span style="color:#e6db74">`</span>id<span style="color:#e6db74">`</span>, <span style="color:#75715e"># 실제 쿼리는 블라인드</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=====</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: <span style="color:#f92672">[</span>4<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: query: SELECT <span style="color:#e6db74">`</span>offering_subscription<span style="color:#e6db74">`</span>.<span style="color:#e6db74">`</span>id<span style="color:#e6db74">`</span>, <span style="color:#75715e"># 실제 쿼리는 블라인드</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: executed time: 0.002
</span></span><span style="display:flex;"><span><span style="color:#f92672">=====</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: <span style="color:#f92672">[</span>5<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: query: UPDATE <span style="color:#e6db74">`</span>offering_subscription<span style="color:#e6db74">`</span> SET  <span style="color:#75715e"># 실제 쿼리는 블라인드</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: executed time: 0.002
</span></span><span style="display:flex;"><span><span style="color:#f92672">=====</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: <span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: query: RELEASE SAVEPOINT <span style="color:#e6db74">`</span>s4377609600_x5<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>CALLED QUERY :: executed time: 0.001
</span></span><span style="display:flex;"><span><span style="color:#f92672">=====</span></span></span></code></pre></td></tr></table>
</div>
</div>
<br>
<h3 id="elapsed_timer">elapsed_timer</h3>
<p>decorator는 함수의 시작시간과 끝나는 시간을 측정하여 함수 실행시간이 어느정도인지를 계산한다.</p>
<br>
<h4 id="elapsed_timer-구현">elapsed_timer 구현</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>def elapsed_timer<span style="color:#f92672">(</span>fn<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    퍼포먼스 체크를 위한 실행 시간 측정 타이머
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    실행 시간을 측정할 함수 위에 @elapsed_timer 를 추가해주시면 됩니다.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    퍼포먼스 테스트가 끝나면 지워주시길 바랍니다.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ex)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    @elapsed_timer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    def pre_allot_offering(offering: Offering):
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    def inner<span style="color:#f92672">(</span>*args, **kwargs<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;\n&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#34;===== {fn.__name__} elapsed time check =====&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        start <span style="color:#f92672">=</span> perf_counter<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        target_func <span style="color:#f92672">=</span> fn<span style="color:#f92672">(</span>*args, **kwargs<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        end <span style="color:#f92672">=</span> perf_counter<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#39;ELAPSED :: total:   start: {start} sec - end: {end} sec&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        duration <span style="color:#f92672">=</span> end - start
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#39;ELAPSED :: duration: {duration} sec&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#39;ELAPSED :: duration in minutes : {str(timedelta(seconds=duration))} mins&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        print<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;\n&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> target_func
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> inner</span></span></code></pre></td></tr></table>
</div>
</div>
<br>
<h4 id="elapsed_timer-결과">elapsed_timer 결과</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">=====</span> pre_allot_offering elapsd time check <span style="color:#f92672">=====</span>
</span></span><span style="display:flex;"><span>ELAPSED :: total:   start: 8.705878 sec - end: 8.72449375 sec
</span></span><span style="display:flex;"><span>ELAPSED :: duration: 0.018615750000000375 sec
</span></span><span style="display:flex;"><span>ELAPSED :: duration in minutes : 0:00:00.018616 mins</span></span></code></pre></td></tr></table>
</div>
</div>
<br>
<h3 id="builtin-profiler">(builtin) @profiler</h3>
<p>메모리를 프로파일링하는 것에 한정한다면 Python에서 builtin으로 제공하는 <code>memory_profiler</code> 라는 것이 있다. 패키지 안의 <code>@profiler</code> 데코레이터를 사용하면 함수 안에서 코드가 실행이 될 때 한 줄 한 줄 얼마의 메모리를 사용했는지를 볼 수 있다.</p>
<p>ORM을 포함하고 있는 코드에도 사용을 해보려 했는데 recursive 하게 동작을 하다가 스택이 터져서 사용을 할 수 없었다. 함수가 한 줄 씩 호출되면서 메모리 사용량을 보기에는 정말 좋은 데코레이터 처럼 보이는데 꼭 다음에 써보도록 해야겠다.</p>
<br>
<h4 id="profiler-사용-예시">@profiler 사용 예시</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>from memory_profiler import profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@profile
</span></span><span style="display:flex;"><span>def main_func<span style="color:#f92672">()</span>:
</span></span><span style="display:flex;"><span>    import random
</span></span><span style="display:flex;"><span>    arr1 <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>random.randint<span style="color:#f92672">(</span>1,10<span style="color:#f92672">)</span> <span style="color:#66d9ef">for</span> i in range<span style="color:#f92672">(</span>100000<span style="color:#f92672">)]</span>
</span></span><span style="display:flex;"><span>    arr2 <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>random.randint<span style="color:#f92672">(</span>1,10<span style="color:#f92672">)</span> <span style="color:#66d9ef">for</span> i in range<span style="color:#f92672">(</span>100000<span style="color:#f92672">)]</span>
</span></span><span style="display:flex;"><span>    arr3 <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>arr1<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>+arr2<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#66d9ef">for</span> i in range<span style="color:#f92672">(</span>100000<span style="color:#f92672">)]</span>
</span></span><span style="display:flex;"><span>    del arr1
</span></span><span style="display:flex;"><span>    del arr2
</span></span><span style="display:flex;"><span>    tot <span style="color:#f92672">=</span> sum<span style="color:#f92672">(</span>arr3<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    del arr3
</span></span><span style="display:flex;"><span>    print<span style="color:#f92672">(</span>tot<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    main_func<span style="color:#f92672">()</span></span></span></code></pre></td></tr></table>
</div>
</div>
<br>
<h4 id="profiler-결과-예시">@profiler 결과 예시</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Line <span style="color:#75715e">#    Mem usage    Increment   Line Contents</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">================================================</span>
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">3</span>     37.0 MiB     37.0 MiB   @profile
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">4</span>                             def main_func<span style="color:#f92672">()</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">5</span>     37.0 MiB      0.0 MiB       import random
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">6</span>     37.6 MiB      0.3 MiB       arr1 <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>random.randint<span style="color:#f92672">(</span>1,10<span style="color:#f92672">)</span> <span style="color:#66d9ef">for</span> i in range<span style="color:#f92672">(</span>100000<span style="color:#f92672">)]</span>
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">7</span>     38.4 MiB      0.3 MiB       arr2 <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>random.randint<span style="color:#f92672">(</span>1,10<span style="color:#f92672">)</span> <span style="color:#66d9ef">for</span> i in range<span style="color:#f92672">(</span>100000<span style="color:#f92672">)]</span>
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">8</span>     39.9 MiB      0.5 MiB       arr3 <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>arr1<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>+arr2<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#66d9ef">for</span> i in range<span style="color:#f92672">(</span>100000<span style="color:#f92672">)]</span>
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">9</span>     39.9 MiB      0.0 MiB       del arr1
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">10</span>     38.0 MiB      0.0 MiB       del arr2
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">11</span>     38.0 MiB      0.0 MiB       tot <span style="color:#f92672">=</span> sum<span style="color:#f92672">(</span>arr3<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">12</span>     37.2 MiB      0.0 MiB       del arr3
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">13</span>     37.2 MiB      0.0 MiB       print<span style="color:#f92672">(</span>tot<span style="color:#f92672">)</span></span></span></code></pre></td></tr></table>
</div>
</div>
<br> 
<h2 id="개선해야-하는-부분">개선해야 하는 부분</h2>
<p>Python의 Decorator는 함수의 시작 - 끝 부분에 추가 action을 할 수 있게 해주는 Wrapper이다. 함수 중간중간에 프로파일링을 해야 한다면 다른 방법으로 접근을 해야 할 것 같다.</p>

    </div>
</article>



<div class="post-comment" data-comment="utterances">
    <span class="post-comment-notloaded">
        <i class="iconfont icon-chatbox-ellipses-sharp"></i>&nbsp;Load comments
    </span>
    <script>
        function loadComment() {
            var commentArea = document.querySelector('.post-comment');
            var utterancesTheme = document.body.getAttribute('data-theme');
            if (utterancesTheme === 'auto') {
                utterancesTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'photon-dark' :
                    'github-light';
            } else {
                utterancesTheme = utterancesTheme === 'dark' ? 'photon-dark' : 'github-light';
            }
            var s = document.createElement('script');
            s.src = 'https://utteranc.es/client.js';
            s.setAttribute('repo', 'leeleelee3264\/github_io_comment');
            s.setAttribute('issue-term', 'pathname');
            s.setAttribute('theme', utterancesTheme);
            s.setAttribute('crossorigin', 'anonymous');
            s.setAttribute('async', '');
            document.querySelector('.post-comment').appendChild(s);
            document.querySelector('span.post-comment-notloaded').setAttribute('style', 'display: none;');
        }
    </script>
</div>


            </div>
            <aside class="col-12 col-md-3 float-left sidebar">
    
    <div class="sidebar-item sidebar-pages">
        <h3>Pages</h3>
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
            <li>
                <a href="/archives/">Archives</a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-links">
        <h3>Links</h3>
        <ul>
            
            <li>
                <a href="https://github.com/leeleelee3264" target="_blank"><span>GitHub</span></a>
            </li>
            
            <li>
                <a href="https://www.linkedin.com/in/seungmin4035/" target="_blank"><span>LinkedIn</span></a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-tags">
        <h3>Tags</h3>
        <div>
            
            <span>
                <a href="/tags/backend/">Backend</a>
            </span>
            
            <span>
                <a href="/tags/book/">Book</a>
            </span>
            
            <span>
                <a href="/tags/general/">General</a>
            </span>
            
            <span>
                <a href="/tags/infra/">Infra</a>
            </span>
            
            <span>
                <a href="/tags/project/">Project</a>
            </span>
            
        </div>
    </div>
    
</aside>

        </div>
        <div class="btn">
    <div class="btn-menu" id="btn-menu">
        <i class="iconfont icon-grid-sharp"></i>
    </div>
    <div class="btn-toggle-mode">
        <i class="iconfont icon-contrast-sharp"></i>
    </div>
    <div class="btn-scroll-top">
        <i class="iconfont icon-chevron-up-circle-sharp"></i>
    </div>
</div>
<aside class="sidebar-mobile" style="display: none;">
  <div class="sidebar-wrapper">
    
    <div class="sidebar-item sidebar-pages">
        <h3>Pages</h3>
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
            <li>
                <a href="/archives/">Archives</a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-links">
        <h3>Links</h3>
        <ul>
            
            <li>
                <a href="https://github.com/leeleelee3264" target="_blank"><span>GitHub</span></a>
            </li>
            
            <li>
                <a href="https://www.linkedin.com/in/seungmin4035/" target="_blank"><span>LinkedIn</span></a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-tags">
        <h3>Tags</h3>
        <div>
            
            <span>
                <a href="/tags/backend/">Backend</a>
            </span>
            
            <span>
                <a href="/tags/book/">Book</a>
            </span>
            
            <span>
                <a href="/tags/general/">General</a>
            </span>
            
            <span>
                <a href="/tags/infra/">Infra</a>
            </span>
            
            <span>
                <a href="/tags/project/">Project</a>
            </span>
            
        </div>
    </div>
    
    
    
    
  </div>
</aside>
    </main>

    <footer>
    <div class="container-lg clearfix">
        <div class="col-12 footer">
            
            <span>&copy; 2020-2022
                <a href="https://leeleelee3264.github.io/">leeleelee3264</a>
                 | <a href="https://github.com/leeleelee3264/leeleelee3264.github.io">Source code</a> 
                | Powered by <a href="https://github.com/dsrkafuu/hugo-theme-fuji/"
                   target="_blank">Fuji-v2</a> &amp; <a href="https://gohugo.io/"
                                                    target="_blank">Hugo</a> 
            </span>
        </div>
    </div>
</footer>

    
<script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/components/prism-core.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/plugins/autoloader/prism-autoloader.min.js"></script>



<script defer src="/assets/js/fuji.min.js"></script>



</body>

</html>
